<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Data Analyzer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Inter Font and custom styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .data-table th, .data-table td {
            padding: 8px;
            text-align: left;
        }
        /* Custom scrollbar for raw data view */
        #rawDataContent {
            max-height: 400px;
            overflow-y: scroll;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">UFW Log Analyzer Dashboard</h1>
            <p class="text-lg text-gray-500">Visualization of enriched firewall log data.</p>
        </header>

        <div id="loading" class="text-center p-8 bg-white rounded-xl card transition duration-300">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-t-blue-500 border-gray-200 rounded-full"></div>
            <p class="mt-4 text-blue-600">Loading data from JSON files...</p>
        </div>

        <div id="data-view" class="space-y-8 hidden">
            <!-- Summary Stats Section -->
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Card 1: Top Ports -->
                <div class="card bg-white rounded-xl p-6">
                    <h2 class="text-xl font-bold mb-4 text-blue-600 border-b pb-2">Top 10 Targeted Ports</h2>
                    <table id="topPortsTable" class="w-full data-table text-sm">
                        <thead>
                            <tr class="text-gray-500"><th>Port</th><th>Hits</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Card 2: Top Countries -->
                <div class="card bg-white rounded-xl p-6">
                    <h2 class="text-xl font-bold mb-4 text-green-600 border-b pb-2">Top 10 Source Countries</h2>
                    <table id="topCountriesTable" class="w-full data-table text-sm">
                        <thead>
                            <tr class="text-gray-500"><th>Country</th><th>Hits</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Card 3: Actions & Protocols -->
                <div class="card bg-white rounded-xl p-6">
                    <h2 class="text-xl font-bold mb-4 text-purple-600 border-b pb-2">Action & Protocol Summary</h2>
                    <h3 class="font-semibold mt-2 mb-1 text-sm text-gray-700">Actions:</h3>
                    <ul id="actionsList" class="text-sm space-y-1"></ul>
                    
                    <h3 class="font-semibold mt-4 mb-1 text-sm text-gray-700">Protocols:</h3>
                    <ul id="protocolsList" class="text-sm space-y-1"></ul>
                </div>
            </section>

            <!-- Raw Data Section -->
            <section class="card bg-gray-800 text-white rounded-xl p-6">
                <h2 class="text-xl font-bold mb-4 text-yellow-300 border-b border-gray-700 pb-2">Raw Log Entries Preview (ufw_ipinfo_db.json)</h2>
                <p class="text-sm text-gray-400 mb-4" id="dbSummary"></p>
                <div id="rawDataContent" class="bg-gray-900 rounded-lg p-3 text-xs font-mono">
                    <pre>Loading raw data...</pre>
                </div>
            </section>

        </div>
    </div>

    <script>
        /**
         * Simulates loading a local JSON file.
         * NOTE: This HTML file MUST be served by a web server, and 'ufw_summary.json' 
         * and 'ufw_ipinfo_db.json' must be in the same directory. Accessing local 
         * files directly via file:// protocol may fail due to browser security restrictions.
         */
        async function loadJsonFile(filename) {
            try {
                const response = await fetch(filename);
                if (!response.ok) {
                    throw new Error(`Failed to fetch ${filename}: ${response.statusText}`);
                }

                if (filename === './ufw_ipinfo_db.json') {
                    // Handle newline-delimited JSON (.jsonl)
                    const text = await response.text();
                    const lines = text.trim().split('\n');
                    return lines.map(line => {
                        try {
                            return JSON.parse(line);
                        } catch {
                            // Silently ignore malformed lines
                            return null;
                        }
                    }).filter(item => item !== null);
                }
                
                // Handle standard JSON
                return await response.json();
            } catch (error) {
                console.error("Loading error for " + filename + ":", error);
                document.getElementById('data-view').innerHTML = `
                    <p class="text-red-500 p-4 bg-red-100 rounded-lg">
                        Error loading data from <strong>${filename}</strong>. 
                        Please ensure the file exists and this HTML page is being 
                        served via a web server (e.g., Python's <code>http.server</code>).
                    </p>
                `;
                return null;
            }
        }

        function renderSummary(summaryData) {
            const renderTable = (data, tableId, keyLabel, valueLabel) => {
                const tbody = document.getElementById(tableId).querySelector('tbody');
                tbody.innerHTML = '';
                data.forEach(item => {
                    const row = tbody.insertRow();
                    row.className = 'border-b last:border-0 hover:bg-gray-50';
                    row.insertCell().textContent = item[keyLabel];
                    row.insertCell().textContent = item[valueLabel];
                });
            };

            // Render Top Ports
            renderTable(summaryData.top_ports, 'topPortsTable', 'port', 'hits');

            // Render Top Countries
            renderTable(summaryData.country_stats, 'topCountriesTable', 'country', 'hits');

            // Render Actions
            const actionsList = document.getElementById('actionsList');
            actionsList.innerHTML = summaryData.actions.map(a => 
                `<li class="${a.action === 'BLOCK' ? 'text-red-400' : 'text-green-400'}">
                    <strong>${a.action}</strong>: ${a.hits} hits
                </li>`
            ).join('');

            // Render Protocols
            const protocolsList = document.getElementById('protocolsList');
            protocolsList.innerHTML = summaryData.protocols.map(p => 
                `<li><strong>${p.proto}</strong>: ${p.hits} hits</li>`
            ).join('');
        }

        function renderRawData(dbData) {
            const dbSummary = document.getElementById('dbSummary');
            const rawDataContent = document.getElementById('rawDataContent');
            
            dbSummary.textContent = `Total unique entries found: ${dbData.length}. Showing the first 5 entries for preview.`;
            
            const previewData = dbData.slice(0, 5);
            
            rawDataContent.innerHTML = `<pre>${previewData.map(item => JSON.stringify(item, null, 2)).join('\n\n')}</pre>`;
        }


        async function initDashboard() {
            const [summary, db] = await Promise.all([
                loadJsonFile('./ufw_summary.json'),
                loadJsonFile('./ufw_ipinfo_db.json')
            ]);
            
            document.getElementById('loading').classList.add('hidden');

            if (summary && db) {
                renderSummary(summary);
                renderRawData(db);
                document.getElementById('data-view').classList.remove('hidden');
            } else {
                // Error message already displayed by loadJsonFile
            }
        }

        window.onload = initDashboard;
    </script>

</body>
</html>
